.. raw:: html

   <!--

   ============================================================================

      DO NOT EDIT THIS FILE! It was generated using Sphinx from:

      Origin:   $URL$
      Revision: $Rev$

   ============================================================================

   -->

.. title:: Manual

.. meta::
    :description: Introducing the main command-line tool for removing skull and other non-brain tissues.
    :keywords: MASS Manual, MASS Tools, MASS Commands, MASS How-to, MASS Help.

.. Page break after table of contents in LaTeX/PDF output.
.. raw:: latex

    \pagebreak


.. _CommandLineTools:

======
Manual
======

General Processing Pipeline
---------------------------

Step 1. 
	Bias correct (N3, N4 or any other method) all of the images so that 
	any large scale inhomogeneities are removed and the input is of reasonable quality
Step 2. 
	Run ``ChooseTemplates`` to select a set of subjects (7-20) to be used as templates 
	for your entire study. If your study is large with a lot of variation (multi site, 
	multi protocol etc), use more templates.
Step 3. 
	Run ``mass`` on the bias corrected images selected in **Step 2** to skullstrip them using 
	the generic templates provided along with the package. These subjects would be your 
	gold standard for the rest of your study, so make sure the quality of the results on 
	these subjects is good. You can manually correct these subjects if you choose to.
Step 4. 
	Rename these results in the following format, with *N* being the template number from 1 to *N*:
	
	*TemplateN.nii.gz*	     - The original intensity image.
	
	*TemplateN_str_cbq.nii.gz*   - The brain mask.
	
Step 5. 
	Run ``mass`` on all subjects using these new templates by specifying the ``-ref`` option to use 
	the newly created study-specific templates.
Step 6. 
	Alternatively, you can skip steps 2-4 and use the generic templates on all of your subjects directly!

Template Selection
------------------

The template selection command within MASS which selects the cluster-centers within
the dataset is named ``ChooseTemplates``. The simplest use is: ::

  ChooseTemplates -list /path/to/list/of/images.lst

This command will return a set of 6 images from the list that are the centroids of 
different clusters (k=6). Internally, it first resamples all of the input images to 
voxel dimensions 2:2:2 to enhance the processing speed and also reducing the memory 
requirement of the process. It then affinely registers all of the input images
to the first image within the input list. So if you have a lot of images within the 
list, it may take a some time for it to process those images. In the last step of this
process, it runs the ``choosetemplates`` executable which loads all the affinely 
registered images into memory and selects the cluster-centers.

If you have access to the computing cluster, it is **highly recommended** that you 
affinely register (using ``flirt`` with 12 dof) all of the input images to one of the 
randomly chosen images yourself and use the ``-a`` option as shown below to notify 
the script that the input images are already affinely registered. This will reduce 
the processing time significantly.

**Supported File Formats:** NIfTI-1_ (recommended)

**Supported Datatypes:** byte (unsigned char, uint8), int8, short, int16, uint16, float, float32, int32.

.. _NIfTI-1: http://nifti.nimh.nih.gov/nifti-1/
.. _ANALYZE 7.5: http://web.archive.org/web/20070927191351/http://www.mayo.edu/bir/PDF/ANALYZE75.pdf
  
Alternatively, the number of desired clusters can be specified
using the ``-clust`` option as: ::

  ChooseTemplates -list /path/to/list/of/images.lst -clust 15
  
If you would like to speed up the processing within this command, you can use multiple
CPU cores on the cluster or on your computer using the ``-MT`` option : ::

  ChooseTemplates -list /path/to/list/of/images.lst -clust 15 -MT 6
  
If you have already affinely registered all input images so they are in the same space,
you can specify that by using the ``-a`` option. Here, you do not need the ``-MT`` option 
as all images have already been registered : ::

  ChooseTemplates -list /path/to/list/of/images.lst -clust 15 -a
  
Additionally, you can also submit this script to your computing cluster if you have a large number 
of images that need be clustered. Make sure that you use the appropriate options for requesting memory 
as well as the number of threads while submitting this script cluster. This will ensure that the script
does not run out of memory or overload the cluster.

MASS Default Command
--------------------

The main command of MASS which removes the skull and other non-brain tissues 
is named ``mass``. The simplest use is: ::

  mass 	-in /path/to/source/sourceimage.hdr

This command will generate 3 files in the /path/to/source/ directory:
	
	*sourceimage_brain.nii.gz*		- The skull-stripped image
	
	*sourceimage_brainmask.nii.gz*		- The final brain mask
	
	*sourceimage_brain_JacRank.nii.gz*	- The Jacobian Rank Mask 

The Jacobian Rank Mask is a combination of the different registrations weighted locally by their jacobian 
determinants. This file can be thresholded using ``mass-thresholdjacobian`` to create stricter or more lenient 
masks. The maximum value within this file can vary with the number of templates that are used for registrations. 
Since it is a sum of ranks, that max value will always be ``N*(N+1)/2``, where ``N`` is the number of templates used.

**Supported File Formats:** NIfTI-1_ (recommended)

**Supported Datatypes:** byte (unsigned char, uint8), int8, short, int16, uint16, float, float32, int32.

.. _NIfTI-1: http://nifti.nimh.nih.gov/nifti-1/
.. _ANALYZE 7.5: http://web.archive.org/web/20070927191351/http://www.mayo.edu/bir/PDF/ANALYZE75.pdf

MASS Options
------------

To run the mass script which will internally do the processing and then submit the 
``mass-registrations`` and ``mass-skullStripping`` jobs: ::
	
   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/;
		
To use the templates without the cerebellum: ::

   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/ 
    -noCere;
    
To use a user defined set of templates: ::

   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/ 
    -ref /Path/To/User/Defined/Templates/;
		
To remove the skull from the input image using the default options. However, do 
not use the computing cluster but run the ``mass-registrations`` jobs serially : ::

   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/ 
    -NOQ;

To remove the skull from the input image using the default options, but without
the computing cluster. Additionally, use 6 CPU cores during ``mass-registrations``
to speed up the process: ::

   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/ 
    -NOQ 
    -MT 6;
		
To remove the skull from the input image that is larger than normal and therefore, 
needs more memory, request 20GB instead of the default 16GB: ::

   mass 
    -in /Path/To/Source/Directory/Input_n3.nii.gz 
    -dest /Path/To/Destination/Directory/ 
    -mem 20;

Threshold Jacobian Rank Mask
----------------------------

By default, the Jacobian Rank Mask is thresholded at 50% of the max value and then processed 
to get the final binary brain mask. If you'd like to threshold the Jacobian Rank Mask at a different percent value, 
say 70% to make the output brain mask stricter than the default value, use the following command: ::

  mass-thresholdJacobian
   -in /Path/To/Source/Directory/Input_n3.nii.gz 
   -jacRank /Path/To/Source/Directory/Input_n3_cbq_JacobianRankMask.nii.gz 
   -perThresh 70
   
On the other hand, if you want to threshold using an absolute value of the Jacobian Rank Mask, say 47, you can run: ::

  mass-thresholdJacobian
   -in /Path/To/Source/Directory/Input_n3.nii.gz 
   -jacRank /Path/To/Source/Directory/Input_n3_cbq_JacobianRankMask.nii.gz 
   -absThresh 47

